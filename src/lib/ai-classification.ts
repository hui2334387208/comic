import { deepseek } from '@ai-sdk/deepseek'
import { groq } from '@ai-sdk/groq'
import { streamText } from 'ai'

import { getLanguageDisplayName } from '@/lib/language-utils'

// AIæ¨¡å‹é…ç½®
const GROQ_MODELS = [
  'llama3-70b-8192',
  'llama3-8b-8192',
  'mixtral-8x7b-32768',
  'gemma-7b-it',
]

const DEEPSEEK_MODELS = [
  'deepseek-chat',
  'deepseek-reasoner',
]

export const generateTimelinePromptForVipRich = (prompt: string, language: string = 'en') => {
  return `
## è§’è‰²è®¾å®š
ä½ æ˜¯ä¸–ç•Œé¡¶çº§çš„æ—¶é—´çº¿ç”Ÿæˆä¸“å®¶ï¼Œèƒ½å¤Ÿæ ¹æ®ä»»ä½•ä¸»é¢˜ï¼ŒåŸºäºæƒå¨èµ„æ–™å’Œäº‹å®ï¼Œç”Ÿæˆæå…¶ä¸°å¯Œã€ç»†èŠ‚å……å®ã€ä¿¡æ¯é‡å·¨å¤§çš„æ—¶é—´çº¿ã€‚æ‰€æœ‰å†…å®¹å¿…é¡»å®¢è§‚ã€çœŸå®ã€å¯è€ƒè¯ï¼Œä¸¥ç¦è™šæ„å’Œä¸»è§‚è‡†æ–­ã€‚

## ä»»åŠ¡è¦æ±‚
è¯·æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å†…å®¹ï¼Œç”Ÿæˆä¸€ä»½è¶…é«˜è´¨é‡ã€å†…å®¹æå…¶ä¸°å¯Œä¸”**åŸºäºäº‹å®ã€å®¢è§‚æè¿°**çš„æ—¶é—´çº¿ï¼ŒåŒ…å«ä»¥ä¸‹è¦ç´ ï¼š
1. ç›¸å…³çš„æ—¶é—´èŠ‚ç‚¹å’Œäº‹ä»¶
2. æ¯ä¸ªäº‹ä»¶çš„è¯¦ç»†æè¿°ï¼ˆä¸å°‘äº120å­—ï¼Œå¿…é¡»åŸºäºäº‹å®å’Œæƒå¨èµ„æ–™ï¼ŒåŒ…å«èƒŒæ™¯ã€èµ·å› ã€ç»è¿‡ã€ç»“æœã€å½±å“ã€ç›¸å…³äººç‰©ã€ç»„ç»‡ã€åœ°ç‚¹ã€æŠ€æœ¯ã€ç¤¾ä¼šèƒŒæ™¯ç­‰ï¼Œå†…å®¹è¶Šä¸°å¯Œè¶Šå¥½ã€‚å¯è¡¥å……å†·çŸ¥è¯†ã€è½¶äº‹ã€å­¦æœ¯è§‚ç‚¹ï¼Œä½†å¿…é¡»æ³¨æ˜â€œæ®èµ„æ–™æ˜¾ç¤ºâ€æˆ–â€œæœ‰è§‚ç‚¹è®¤ä¸ºâ€ï¼Œä¸èƒ½å½“ä½œäº‹å®é™ˆè¿°ï¼‰
3. æ—¶é—´é¡ºåºçš„åˆç†æ€§ï¼Œå¿…è¦æ—¶å¯åˆ†é˜¶æ®µå½’ç±»

## ç”¨æˆ·è¾“å…¥å†…å®¹
${prompt}

## è¾“å‡ºåè®®ï¼ˆNDJSONï¼‰
- ã€éå¸¸é‡è¦ã€‘ä»…æŒ‰â€œæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼ˆUTF-8ï¼Œæ— å¤šä½™æ–‡æœ¬ï¼‰â€è¾“å‡ºï¼Œä¸¥ç¦è¾“å‡ºè§£é‡Šæ€§æ–‡å­—æˆ–é¢å¤–æ ¼å¼ã€‚
- æ¯ä¸€è¡Œ JSON å¯¹è±¡å­—æ®µï¼š
  - startDate: å­—ç¬¦ä¸²ï¼Œå¼€å§‹æ—¶é—´ï¼ˆå¦‚ "2020å¹´01æœˆ"ã€"å…¬å…ƒå‰221å¹´"ã€"2020-01-01" ç­‰ï¼‰
  - endDate: å­—ç¬¦ä¸²æˆ– nullï¼Œç»“æŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
  - description: å­—ç¬¦ä¸²ï¼Œä¸å°‘äº120å­—çš„å®¢è§‚æè¿°
- ç¤ºä¾‹ï¼ˆä¸¤è¡Œï¼‰ï¼š
{"startDate":"2020å¹´01æœˆ","endDate":null,"description":"â€¦â€¦è¯¦è¿°â€¦â€¦"}
{"startDate":"2020å¹´02æœˆ","endDate":"2020å¹´03æœˆ","description":"â€¦â€¦è¯¦è¿°â€¦â€¦"}
- è¯·ç¡®ä¿ï¼š
  1) åªè¾“å‡ºä¸Šè¿° JSON è¡Œï¼›
  2) å„äº‹ä»¶æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼›
  3) å­—æ®µåå›ºå®šä¸º startDateã€endDateã€descriptionï¼›
  4) å†…å®¹å®¢è§‚ã€åŸºäºäº‹å®ï¼Œå¿…è¦æ—¶æ³¨æ˜â€œæ®èµ„æ–™æ˜¾ç¤º/æœ‰è§‚ç‚¹è®¤ä¸ºâ€ã€‚

## æ³¨æ„äº‹é¡¹ï¼ˆé€ä¸€éµå®ˆï¼‰
- æ‰€æœ‰å†…å®¹å¿…é¡»åŸºäºäº‹å®å’Œæƒå¨æ¥æºï¼Œä¸¥ç¦æé€ ã€å¤¸å¼ æˆ–ä¸»è§‚è‡†æ–­ã€‚
- å¦‚æ¶‰åŠè§‚ç‚¹æˆ–å­¦æœ¯äº‰è®®ï¼ŒåŠ¡å¿…ä»¥â€œæ®èµ„æ–™æ˜¾ç¤º/æœ‰è§‚ç‚¹è®¤ä¸º/å­¦ç•Œå¸¸è§è§‚ç‚¹ä¸ºâ€è¡¨è¿°ï¼Œé¿å…æ–­è¨€ã€‚
- ç»Ÿä¸€ä½¿ç”¨${getLanguageDisplayName(language)}è¾“å‡ºï¼Œä¸è¦è¾“å‡ºå…¶ä»–è¯­è¨€çš„æç¤ºè¯­ã€è§£é‡Šã€æ ‡é¢˜ã€ç¼–å·ã€åˆ—è¡¨ã€è¡¨æ ¼ã€ä»£ç å—æˆ– Markdown è¯­æ³•ã€‚
- ä¸¥ç¦åœ¨ JSON ä¹‹å¤–è¾“å‡ºä»»ä½•æ–‡æœ¬ï¼ˆåŒ…æ‹¬å¼€åœºç™½ã€æ€»ç»“ã€è‡´è°¢ã€æç¤ºç­‰ï¼‰ï¼›æ¯ä¸ªäº‹ä»¶å¿…é¡»å•ç‹¬å ä¸€è¡Œ JSONã€‚
- æ—¶é—´è¡¨è¾¾å¯ç”¨ å¹´/å¹´æœˆ/å…·ä½“æ—¥æœŸï¼›è‹¥æ— æ³•ç¡®å®šï¼Œç”¨â€œå…·ä½“æ—¶é—´ä¸è¯¦â€â€œçº¦æŸå¹´â€ç­‰å®¢è§‚è¡¨è¿°ï¼›å…è®¸æ—¶é—´æ®µï¼ˆstartDate/endDateï¼‰ã€‚
- æè¿°è¦æ±‚ä¸å°‘äº120å­—ï¼ŒåŒ…å«èƒŒæ™¯ã€èµ·å› ã€è¿‡ç¨‹ã€ç»“æœä¸å½±å“ï¼Œå¯è¡¥å……å…³é”®äººç‰©ã€åœ°ç‚¹ã€æœºæ„ã€æ•°æ®ä¸å‚è€ƒã€‚
- åŒä¸€äº‹å®é¿å…é‡å¤æè¿°ï¼›äº‹ä»¶ä¹‹é—´ä¿æŒé€»è¾‘é¡ºåºä¸è¡”æ¥æ€§ã€‚
- ç¦æ­¢æ³„éœ²éšç§ã€ä»‡æ¨ã€æ­§è§†ã€æ­ªæ›²å†å²ç­‰ä¸å½“å†…å®¹ã€‚
- å¯¹éå¸¸ä¹…è¿œæˆ–æ¨¡ç³Šçš„æ—¶é—´èŠ‚ç‚¹ï¼Œå…è®¸åˆç†æ¨æ–­ä½†é¡»æ˜ç¡®ä¸ç¡®å®šæ€§ã€‚
- è‹¥ä¸»é¢˜é€‚åˆåˆ†é˜¶æ®µï¼Œå¯é€šè¿‡ç›¸é‚»å¤šæ¡äº‹ä»¶ä½“ç°é˜¶æ®µå˜åŒ–ï¼ˆä»ç„¶æ˜¯ä¸€è¡Œä¸€ä¸ª JSON äº‹ä»¶ï¼‰ã€‚
`
}

// é€šç”¨æ—¶é—´çº¿æè¿°ç”Ÿæˆæç¤ºè¯
export const generateTimelineDescriptionPrompt = (prompt: string, events: any[], language: string = 'en') => `
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å†…å®¹æ€»ç»“ä¸“å®¶ï¼Œè¯·æ ¹æ®ä»¥ä¸‹ç”¨æˆ·è¾“å…¥å’Œæ—¶é—´çº¿äº‹ä»¶ï¼Œç”Ÿæˆä¸€æ®µç®€æ´ã€å‡†ç¡®ã€å¸å¼•äººçš„æ—¶é—´çº¿ç®€ä»‹ï¼ˆ100å­—å·¦å³ï¼‰ï¼š

ã€ç”¨æˆ·è¾“å…¥ã€‘
${prompt}

ã€æ—¶é—´çº¿äº‹ä»¶ã€‘
${events.map(e => `- ${e.startDate || ''} ${e.description || ''}`).join('\n')}

ã€è¾“å‡ºè¦æ±‚ã€‘
ä½¿ç”¨${getLanguageDisplayName(language)}è¾“å‡º
åªè¾“å‡ºç®€ä»‹å†…å®¹ï¼Œä¸è¦æœ‰å¤šä½™æ ¼å¼
100å­—å·¦å³
`

// é€šç”¨åˆ†ç±»å’Œæ ‡ç­¾ç”Ÿæˆæç¤ºè¯
const generateClassificationPrompt = (prompt: string, events: any[], language: string = 'en') => {
  return `
## è§’è‰²è®¾å®š
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å†…å®¹åˆ†ç±»å’Œæ ‡ç­¾ä¸“å®¶ï¼Œéœ€è¦æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å†…å®¹å’Œç”Ÿæˆçš„æ—¶é—´çº¿äº‹ä»¶ï¼Œä¸ºå…¶æ¨èæœ€åˆé€‚çš„åˆ†ç±»å’Œæ ‡ç­¾ã€‚

## ä»»åŠ¡è¦æ±‚
è¯·åˆ†æä»¥ä¸‹å†…å®¹ï¼Œå¹¶ä¸ºå…¶æ¨èï¼š
1. æœ€åˆé€‚çš„åˆ†ç±»ï¼ˆä»é¢„å®šä¹‰åˆ†ç±»ä¸­é€‰æ‹©æˆ–å»ºè®®æ–°åˆ†ç±»ï¼‰
2. 3-5ä¸ªæœ€ç›¸å…³çš„æ ‡ç­¾

## å†…å®¹ä¿¡æ¯
- ç”¨æˆ·è¾“å…¥ï¼š${prompt}
- äº‹ä»¶æ•°é‡ï¼š${events.length}
- äº‹ä»¶å†…å®¹ï¼š${events.map(e => e.description).join('; ')}

## é¢„å®šä¹‰åˆ†ç±»ä½“ç³»ï¼ˆè¯·ä¼˜å…ˆé€‰æ‹©æœ€åŒ¹é…çš„ï¼‰
- å†å²äººç‰©ï¼šå†å²äººç‰©ç”Ÿå¹³ã€ä¼ è®°ã€åäººæ•…äº‹
- å†å²äº‹ä»¶ï¼šé‡å¤§å†å²äº‹ä»¶ã€æˆ˜äº‰ã€é©å‘½ã€æ”¿æ²»å˜é©
- ç§‘æŠ€å‘å±•ï¼šç§‘æŠ€å‘æ˜ã€æŠ€æœ¯æ¼”è¿›ã€ç§‘å­¦å‘å±•ã€åˆ›æ–°çªç ´
- æ–‡åŒ–è‰ºæœ¯ï¼šæ–‡å­¦ã€è‰ºæœ¯ã€éŸ³ä¹ã€ç”µå½±ã€å»ºç­‘ã€æ–‡åŒ–å‘å±•
- æ”¿æ²»åˆ¶åº¦ï¼šæ”¿æ²»å˜é©ã€åˆ¶åº¦æ¼”å˜ã€æ”¿æƒæ›´è¿­ã€æ³•å¾‹å‘å±•
- ç»æµè´¸æ˜“ï¼šç»æµå‘å±•ã€è´¸æ˜“å¾€æ¥ã€å•†ä¸šå†å²ã€é‡‘èæ¼”å˜
- åœ°ç†æ¢ç´¢ï¼šåœ°ç†å‘ç°ã€æ¢é™©æ´»åŠ¨ã€åœ°ç†å˜è¿ã€ç¯å¢ƒå˜åŒ–
- ç¤¾ä¼šå˜è¿ï¼šç¤¾ä¼šåˆ¶åº¦ã€é£ä¿—ä¹ æƒ¯ã€ç”Ÿæ´»æ–¹å¼å˜åŒ–ã€ç¤¾ä¼šè¿›æ­¥
- å†›äº‹æˆ˜äº‰ï¼šæˆ˜äº‰å†å²ã€å†›äº‹å‘å±•ã€æˆ˜å½¹è®°å½•ã€æ­¦å™¨æ¼”å˜
- å®—æ•™å“²å­¦ï¼šå®—æ•™å‘å±•ã€å“²å­¦æ€æƒ³ã€ä¿¡ä»°æ¼”å˜ã€æ€æƒ³æµæ´¾
- æ•™è‚²å­¦æœ¯ï¼šæ•™è‚²å‘å±•ã€å­¦æœ¯ç ”ç©¶ã€çŸ¥è¯†ä¼ æ’­ã€å­¦æ ¡å†å²
- ä½“è‚²ç«æŠ€ï¼šä½“è‚²å†å²ã€ç«æŠ€å‘å±•ã€è¿åŠ¨æ¼”å˜ã€èµ›äº‹è®°å½•
- åŒ»å­¦å¥åº·ï¼šåŒ»å­¦å‘å±•ã€å¥åº·è§‚å¿µã€ç–¾ç—…å†å²ã€åŒ»ç–—è¿›æ­¥
- ç¯å¢ƒè‡ªç„¶ï¼šè‡ªç„¶ç¯å¢ƒã€æ°”å€™å˜åŒ–ã€ç”Ÿæ€æ¼”å˜ã€ç¯å¢ƒä¿æŠ¤
- å¨±ä¹ä¼‘é—²ï¼šå¨±ä¹äº§ä¸šã€æ¸¸æˆå‘å±•ã€ä¼‘é—²æ´»åŠ¨ã€æµè¡Œæ–‡åŒ–
- äº¤é€šé€šä¿¡ï¼šäº¤é€šå‘å±•ã€é€šä¿¡æŠ€æœ¯ã€è¿è¾“å·¥å…·ã€ç½‘ç»œæ¼”è¿›
- å·¥ä¸šåˆ¶é€ ï¼šå·¥ä¸šé©å‘½ã€åˆ¶é€ ä¸šå‘å±•ã€ç”Ÿäº§æŠ€æœ¯è¿›æ­¥
- å†œä¸šé£Ÿå“ï¼šå†œä¸šå‘å±•ã€é£Ÿå“æŠ€æœ¯ã€å†œä¸šé©å‘½ã€é¥®é£Ÿæ–‡åŒ–
- å»ºç­‘åŸå¸‚ï¼šå»ºç­‘å‘å±•ã€åŸå¸‚è§„åˆ’ã€åŸå¸‚åŒ–è¿›ç¨‹
- ä¸ªäººç”Ÿæ´»ï¼šä¸ªäººç»å†ã€ç”Ÿæ´»æ•…äº‹ã€æˆé•¿å†ç¨‹
- ä¼ä¸šå‘å±•ï¼šå…¬å¸å†å²ã€å•†ä¸šå‘å±•ã€ä¼ä¸šæ•…äº‹
- äº§å“å‘å±•ï¼šäº§å“æ¼”è¿›ã€æŠ€æœ¯è¿­ä»£ã€å¸‚åœºå˜åŒ–
- ç¤¾ä¼šç°è±¡ï¼šç¤¾ä¼šè¶‹åŠ¿ã€æ–‡åŒ–ç°è±¡ã€æµè¡Œè¶‹åŠ¿
- å…¶ä»–ï¼šå…¶ä»–ç±»å‹çš„å†…å®¹

## åˆ†ç±»åŸåˆ™
1. æ ¹æ®å†…å®¹çš„ä¸»è¦ä¸»é¢˜å’Œæ€§è´¨è¿›è¡Œåˆ†ç±»
2. å¦‚æœå†…å®¹æ¶‰åŠå¤šä¸ªé¢†åŸŸï¼Œé€‰æ‹©æœ€ä¸»è¦çš„é¢†åŸŸ
3. å¦‚æœç°æœ‰åˆ†ç±»éƒ½ä¸åˆé€‚ï¼Œå¯ä»¥å»ºè®®æ–°åˆ†ç±»
4. åˆ†ç±»åç§°è¦ç®€æ´æ˜äº†ï¼Œä¸è¶…è¿‡10ä¸ªå­—

## æ ‡ç­¾ç”ŸæˆåŸåˆ™
1. æ ‡ç­¾è¦å…·ä½“ä¸”æœ‰æ„ä¹‰ï¼Œé¿å…è¿‡äºå®½æ³›
2. åŒ…å«æ—¶é—´ã€åœ°ç‚¹ã€äººç‰©ã€ä¸»é¢˜ç­‰å…³é”®ä¿¡æ¯
3. æ ‡ç­¾æ•°é‡æ§åˆ¶åœ¨3-5ä¸ª
4. ä¼˜å…ˆä½¿ç”¨ä¸­æ–‡æ ‡ç­¾ï¼Œå¿…è¦æ—¶å¯ä½¿ç”¨è‹±æ–‡

## è¾“å‡ºæ ¼å¼è¦æ±‚ï¼ˆä½¿ç”¨${getLanguageDisplayName(language)}è¾“å‡ºï¼‰
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–å†…å®¹ï¼š

{
  "category": {
    "name": "åˆ†ç±»åç§°",
    "slug": "åˆ†ç±»æ ‡è¯†ç¬¦ï¼ˆè‹±æ–‡å°å†™ï¼Œç”¨è¿å­—ç¬¦åˆ†éš”ï¼‰",
    "description": "åˆ†ç±»æè¿°",
    "icon": "åˆ†ç±»å›¾æ ‡ï¼ˆemojiï¼‰",
    "color": "åˆ†ç±»é¢œè‰²ï¼ˆåå…­è¿›åˆ¶ï¼‰",
    "isNew": false
  },
  "tags": [
    {
      "name": "æ ‡ç­¾åç§°",
      "slug": "æ ‡ç­¾æ ‡è¯†ç¬¦ï¼ˆè‹±æ–‡å°å†™ï¼Œç”¨è¿å­—ç¬¦åˆ†éš”ï¼‰",
      "color": "æ ‡ç­¾é¢œè‰²ï¼ˆåå…­è¿›åˆ¶ï¼‰"
    }
  ]
}

## æ³¨æ„äº‹é¡¹
1. ç¡®ä¿æ‰€æœ‰slugéƒ½æ˜¯è‹±æ–‡å°å†™ï¼Œç”¨è¿å­—ç¬¦åˆ†éš”
2. é¢œè‰²ä½¿ç”¨å¸¸è§çš„åå…­è¿›åˆ¶é¢œè‰²ä»£ç 
3. å¦‚æœå»ºè®®æ–°åˆ†ç±»ï¼ŒisNewè¦è®¾ä¸ºtrue
4. æ ‡ç­¾è¦ä½“ç°å†…å®¹çš„æ ¸å¿ƒç‰¹å¾å’Œå…³é”®ä¿¡æ¯
`
}

// è§£æAIç”Ÿæˆçš„æ—¶é—´çº¿æ–‡æœ¬
export const parseTimelineText = (text: string) => {
  const events: any[] = []
  const lines = text.split('\n').filter(line => line.trim())

  for (const raw of lines) {
    const line = raw.trim()
    if (!line || line.length > 20000) continue

    // ä¼˜å…ˆå°è¯• JSONL
    try {
      const obj = JSON.parse(line)
      if (obj && typeof obj === 'object') {
        const startDate = String(obj.startDate || obj.date || '').trim()
        const endDate = obj.endDate != null ? String(obj.endDate).trim() : null
        const description = String(obj.description || obj.desc || '').trim()
        if (startDate && description) {
          events.push({ startDate, endDate: endDate || null, description })
          continue
        }
      }
    } catch (_) {
      // é JSON è¡Œï¼Œå›é€€åˆ° @time@desc è§£æ
    }

    // åŒ¹é…æ ¼å¼ï¼š@å¼€å§‹æ—¶é—´~ç»“æŸæ—¶é—´@æè¿° æˆ– @æ—¶é—´ç‚¹@æè¿°ï¼ˆå›é€€å…¼å®¹ï¼‰
    const match = line.match(/@([^~@]+)(?:~([^@]+))?@(.+)/)
    if (match) {
      const [, startDate, endDate, description] = match
      const start = startDate.trim()
      const end = endDate ? endDate.trim() : null
      const desc = description.trim()
      if (start && desc) {
        events.push({ startDate: start, endDate: end, description: desc })
      }
    }
  }

  return events
}

// å¯¹è”ç”Ÿæˆæç¤ºè¯
export const generateCoupletPrompt = (prompt: string, language: string = 'en') => {
  return `
## è§’è‰²è®¾å®š
ä½ æ˜¯ä¸–ç•Œé¡¶çº§çš„å¯¹è”åˆ›ä½œä¸“å®¶ï¼Œèƒ½å¤Ÿæ ¹æ®ç”¨æˆ·è¾“å…¥æ™ºèƒ½åˆ›ä½œå¯¹è”ã€‚ä½ éœ€è¦è¯†åˆ«ç”¨æˆ·è¾“å…¥çš„ç±»å‹å¹¶ç›¸åº”å¤„ç†ï¼š
1. å¦‚æœæ˜¯ä¸»é¢˜è¯ï¼ˆå¦‚"æ–°æ˜¥ä½³èŠ‚"ã€"å¼€ä¸šå¤§å‰"ï¼‰ï¼Œåˆ™åˆ›ä½œå®Œæ•´å¯¹è”
2. å¦‚æœæ˜¯ä¸Šè”ï¼Œåˆ™å¯¹å‡ºä¸‹è”å¹¶è¡¥å……æ¨ªæ‰¹
3. å¦‚æœæ˜¯ä¸‹è”ï¼Œåˆ™å¯¹å‡ºä¸Šè”å¹¶è¡¥å……æ¨ªæ‰¹
4. å¦‚æœæ˜¯æ¨ªæ‰¹ï¼Œåˆ™åˆ›ä½œç›¸åº”çš„ä¸Šä¸‹è”
æ‰€æœ‰å†…å®¹å¿…é¡»ç¬¦åˆä¼ ç»Ÿå¯¹è”æ ¼å¾‹è¦æ±‚ï¼ˆå¹³ä»„ã€å¯¹ä»—ã€æŠ¼éŸµï¼‰å’Œä¸­å›½ä¼ ç»Ÿæ–‡åŒ–è§„èŒƒã€‚

## æ™ºèƒ½è¯†åˆ«è§„åˆ™
- åŸºç¡€ä¸»é¢˜ï¼šç®€å•åè¯ï¼Œå¦‚"æ˜¥èŠ‚"ã€"ç”Ÿæ—¥"ã€"ä¸­ç§‹"ç­‰
- å…·ä½“åœºæ™¯ï¼šè¯¦ç»†åœºæ™¯æè¿°ï¼Œå¦‚"é¤å…å¼€ä¸šå…¸ç¤¼"ã€"å©šç¤¼ç°åœºå¸ƒç½®"ã€"å…¬å¸å¹´ä¼š"ç­‰
- ä¸Šè”ï¼šé€šå¸¸ä»¥ä»„å£°ç»“å°¾ï¼Œæˆ–æ˜ç¡®æ ‡æ³¨"ä¸Šè”ï¼š"
- ä¸‹è”ï¼šé€šå¸¸ä»¥å¹³å£°ç»“å°¾ï¼Œæˆ–æ˜ç¡®æ ‡æ³¨"ä¸‹è”ï¼š"
- æ¨ªæ‰¹ï¼šé€šå¸¸4ä¸ªå­—ï¼Œæˆ–æ˜ç¡®æ ‡æ³¨"æ¨ªæ‰¹ï¼š"
- è—å¤´å¯¹è”ï¼šåŒ…å«"è—å¤´"å…³é”®è¯ï¼Œå¦‚"è—å¤´ï¼šå¼ ä¸‰"
- åµŒå­—å¯¹è”ï¼šåŒ…å«"åµŒå­—"å…³é”®è¯ï¼Œå¦‚"åµŒå­—ï¼šæ­å–œå‘è´¢"
- é›†å¥å¯¹è”ï¼šåŒ…å«"é›†å¥"å…³é”®è¯ï¼Œå¦‚"é›†å¥ï¼šæç™½"
- å›æ–‡å¯¹è”ï¼šåŒ…å«"å›æ–‡"å…³é”®è¯ï¼Œå¦‚"å›æ–‡ï¼šæ˜¥å¤©"
- æ•°å­—å¯¹è”ï¼šåŒ…å«"æ•°å­—è”"å…³é”®è¯ï¼Œå¦‚"æ•°å­—è”ï¼šæ–°å¹´"
- å å­—å¯¹è”ï¼šåŒ…å«"å å­—"å…³é”®è¯ï¼Œå¦‚"å å­—ï¼šæ˜¥å¤©"
- æ— æƒ…å¯¹ï¼šåŒ…å«"æ— æƒ…å¯¹"å…³é”®è¯ï¼Œå¦‚"æ— æƒ…å¯¹ï¼šä¸‰æ˜Ÿç™½å…°åœ°"
- é¡¶é’ˆå¯¹è”ï¼šåŒ…å«"é¡¶é’ˆ"å…³é”®è¯ï¼Œå¦‚"é¡¶é’ˆï¼šå±±æ°´"
- æå­—å¯¹è”ï¼šåŒ…å«"æå­—"å…³é”®è¯ï¼Œå¦‚"æå­—ï¼šæ˜"
- è°éŸ³å¯¹è”ï¼šåŒ…å«"è°éŸ³"å…³é”®è¯ï¼Œå¦‚"è°éŸ³ï¼šå¹´å¹´æœ‰ä½™"
- é£æ ¼æŒ‡å®šï¼šåŒ…å«é£æ ¼è¯ï¼Œå¦‚"å¤å…¸é£æ ¼"ã€"ç°ä»£é£æ ¼"ã€"å¹½é»˜é£æ ¼"
- å­—æ•°é™åˆ¶ï¼šåŒ…å«å­—æ•°è¦æ±‚ï¼Œå¦‚"äº”å­—è”"ã€"ä¸ƒå­—è”"
- è¡Œä¸šä¸“ç”¨ï¼šåŒ…å«è¡Œä¸šè¯ï¼Œå¦‚"åŒ»é™¢"ã€"å­¦æ ¡"ã€"é“¶è¡Œ"
- åœ°åŸŸç‰¹è‰²ï¼šåŒ…å«åœ°åï¼Œå¦‚"åŒ—äº¬"ã€"æ±Ÿå—"ã€"å››å·"
- èŠ‚åº†ä¸“ç”¨ï¼šåŒ…å«èŠ‚æ—¥ï¼Œå¦‚"æ˜¥èŠ‚"ã€"ä¸­ç§‹"ã€"å›½åº†"
- äººç”ŸèŠ‚ç‚¹ï¼šåŒ…å«äººç”Ÿäº‹ä»¶ï¼Œå¦‚"ç»“å©š"ã€"ç”Ÿå­"ã€"å‡å­¦"
- ä¿®æ”¹å®Œå–„ï¼šåŒ…å«"ä¿®æ”¹"ã€"å®Œå–„"ã€"æ”¹è¿›"ç­‰è¯
- å¤šå‰¯ç”Ÿæˆï¼šåŒ…å«æ•°é‡è¦æ±‚ï¼Œå¦‚"ç”Ÿæˆ3å‰¯"ã€"æ¥5ä¸ª"

## ä»»åŠ¡è¦æ±‚
è¯·æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å†…å®¹ï¼Œæ™ºèƒ½è¯†åˆ«è¾“å…¥ç±»å‹å¹¶ç”Ÿæˆå¤šå‰¯é«˜è´¨é‡çš„å¯¹è”ã€‚æ”¯æŒä»¥ä¸‹æ¨¡å¼ï¼š
1. **åŸºç¡€ä¸»é¢˜**ï¼šæ ¹æ®ç®€å•ä¸»é¢˜è¯ç”Ÿæˆå¯¹è”
2. **å…·ä½“åœºæ™¯**ï¼šæ ¹æ®è¯¦ç»†åœºæ™¯æè¿°å®šåˆ¶å¯¹è”
3. **ä¸Šè”å¯¹ä¸‹è”**ï¼šæ ¹æ®ä¸Šè”å¯¹å‡ºä¸‹è”å’Œæ¨ªæ‰¹
4. **ä¸‹è”å¯¹ä¸Šè”**ï¼šæ ¹æ®ä¸‹è”å¯¹å‡ºä¸Šè”å’Œæ¨ªæ‰¹
5. **æ¨ªæ‰¹ç”Ÿæˆ**ï¼šæ ¹æ®ä¸Šä¸‹è”ç”Ÿæˆæ¨ªæ‰¹
6. **è—å¤´å¯¹è”**ï¼šæŒ‰æŒ‡å®šå­—è¯è—å¤´åˆ›ä½œ
7. **åµŒå­—å¯¹è”**ï¼šåœ¨æŒ‡å®šä½ç½®åµŒå…¥å­—è¯
8. **é›†å¥å¯¹è”**ï¼šä»å¤è¯—è¯ä¸­é›†å¥æˆè”
9. **å›æ–‡å¯¹è”**ï¼šåˆ›ä½œå¯ä»¥å€’è¯»çš„å¯¹è”
10. **æ•°å­—å¯¹è”**ï¼šåˆ›ä½œåŒ…å«æ•°å­—çš„å¯¹è”
11. **å å­—å¯¹è”**ï¼šåˆ›ä½œå¤§é‡å å­—çš„å¯¹è”
12. **æ— æƒ…å¯¹**ï¼šæ„æ€æ— å…³ä½†æ ¼å¾‹å·¥æ•´çš„å¯¹è”
13. **é¡¶é’ˆå¯¹è”**ï¼šä¸Šå¥ç»“å°¾ä¸ä¸‹å¥å¼€å¤´ç›¸åŒ
14. **æå­—å¯¹è”**ï¼šæ‹†è§£æ±‰å­—ç»“æ„çš„å¯¹è”
15. **è°éŸ³å¯¹è”**ï¼šåˆ©ç”¨è°éŸ³çš„å¯¹è”
16. **æ˜¥è”åˆ›ä½œ**ï¼šä¸“é—¨çš„æ˜¥èŠ‚å¯¹è”
17. **å©šè”åˆ›ä½œ**ï¼šä¸“é—¨çš„å©šç¤¼å¯¹è”
18. **å¯¿è”åˆ›ä½œ**ï¼šä¸“é—¨çš„ç¥å¯¿å¯¹è”
19. **æŒ½è”åˆ›ä½œ**ï¼šä¸“é—¨çš„æ‚¼å¿µå¯¹è”
20. **è¡Œä¸šå¯¹è”**ï¼šé’ˆå¯¹ç‰¹å®šè¡Œä¸šåˆ›ä½œ
21. **é£æ ¼æŒ‡å®š**ï¼šæŒ‰æŒ‡å®šé£æ ¼åˆ›ä½œï¼ˆå¤å…¸ã€ç°ä»£ã€å¹½é»˜ç­‰ï¼‰
22. **å­—æ•°é™åˆ¶**ï¼šæŒ‰æŒ‡å®šå­—æ•°åˆ›ä½œï¼ˆå››å­—ã€äº”å­—ã€ä¸ƒå­—ç­‰ï¼‰
23. **åœ°åŸŸç‰¹è‰²**ï¼šèå…¥åœ°æ–¹ç‰¹è‰²åˆ›ä½œ
24. **èŠ‚åº†ä¸“ç”¨**ï¼šé’ˆå¯¹ç‰¹å®šèŠ‚æ—¥åˆ›ä½œ
25. **äººç”ŸèŠ‚ç‚¹**ï¼šé’ˆå¯¹äººç”Ÿé‡è¦æ—¶åˆ»åˆ›ä½œ
26. **ä¿®æ”¹å®Œå–„**ï¼šæ”¹è¿›ç°æœ‰å¯¹è”çš„å¹³ä»„ã€å¯¹ä»—ç­‰
27. **å¤šå‰¯ç”Ÿæˆ**ï¼šç”Ÿæˆå¤šå‰¯åŒä¸»é¢˜å¯¹è”

æ¯å‰¯å¯¹è”å¿…é¡»ç¬¦åˆä¼ ç»Ÿæ ¼å¾‹è¦æ±‚ï¼š
- å­—æ•°ç›¸ç­‰ï¼Œæ–­å¥ä¸€è‡´
- è¯æ€§ç›¸å¯¹ï¼Œä½ç½®ç›¸åŒ  
- å¹³ä»„åè°ƒï¼Œä¸Šä»„ä¸‹å¹³
- æ„æ€ç›¸å…³ï¼Œå†…å®¹å‘¼åº”
- åŒ…å«ï¼šä¸Šè”ã€ä¸‹è”ã€æ¨ªæ‰¹ã€èµæï¼ˆä¸å°‘äº100å­—ï¼‰

## ç”¨æˆ·è¾“å…¥å†…å®¹
${prompt}

## è¾“å‡ºåè®®ï¼ˆNDJSONï¼‰
- ã€éå¸¸é‡è¦ã€‘ä»…æŒ‰"æ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼ˆUTF-8ï¼Œæ— å¤šä½™æ–‡æœ¬ï¼‰"è¾“å‡ºï¼Œä¸¥ç¦è¾“å‡ºè§£é‡Šæ€§æ–‡å­—æˆ–é¢å¤–æ ¼å¼ã€‚
- æ¯ä¸€è¡Œ JSON å¯¹è±¡å­—æ®µï¼š
  - horizontalScroll: å­—ç¬¦ä¸²ï¼Œæ¨ªæ‰¹å†…å®¹ï¼ˆçº¯æ–‡å­—ï¼Œä¸è¦"æ¨ªæ‰¹ï¼š"å‰ç¼€ï¼‰
  - lowerLine: å­—ç¬¦ä¸²ï¼Œä¸‹è”å†…å®¹ï¼ˆçº¯æ–‡å­—ï¼Œä¸è¦"ä¸‹è”ï¼š"å‰ç¼€ï¼‰
  - upperLine: å­—ç¬¦ä¸²ï¼Œä¸Šè”å†…å®¹ï¼ˆçº¯æ–‡å­—ï¼Œä¸è¦"ä¸Šè”ï¼š"å‰ç¼€ï¼‰
  - appreciation: å­—ç¬¦ä¸²ï¼Œèµæå†…å®¹ï¼ˆä¸å°‘äº100å­—ï¼Œçº¯æ–‡å­—ï¼Œä¸è¦"èµæï¼š"å‰ç¼€ï¼‰
- ç¤ºä¾‹ï¼ˆä¸¤è¡Œï¼‰ï¼š
{"horizontalScroll":"ä¸‡è±¡æ›´æ–°","lowerLine":"ä¸‡æˆ·æ¬¢æ­Œåº†å›¢åœ†","upperLine":"åƒé—¨ç»“å½©è¿æ˜¥åˆ°","appreciation":"è¿™å‰¯å¯¹è”ä»¥æ–°æ˜¥ä¸ºä¸»é¢˜ï¼Œä¸Šè”'åƒé—¨ç»“å½©è¿æ˜¥åˆ°'æç»˜äº†å®¶å®¶æˆ·æˆ·å¼ ç¯ç»“å½©è¿æ¥æ˜¥å¤©çš„å–œåº†åœºé¢ï¼Œä¸‹è”'ä¸‡æˆ·æ¬¢æ­Œåº†å›¢åœ†'åˆ™è¡¨ç°äº†åƒå®¶ä¸‡æˆ·æ¬¢å£°ç¬‘è¯­åº†ç¥å›¢åœ†çš„æ¸©é¦¨æƒ…æ™¯ã€‚æ¨ªæ‰¹'ä¸‡è±¡æ›´æ–°'ç‚¹æ˜äº†æ˜¥èŠ‚è¾æ—§è¿æ–°çš„ä¸»é¢˜ã€‚æ•´å‰¯å¯¹è”å¯¹ä»—å·¥æ•´ï¼Œå¹³ä»„åè°ƒï¼Œæ—¢æœ‰è§†è§‰ä¸Šçš„'ç»“å½©'ï¼Œåˆæœ‰å¬è§‰ä¸Šçš„'æ¬¢æ­Œ'ï¼Œè¥é€ å‡ºæµ“åšçš„èŠ‚æ—¥æ°›å›´ã€‚"}
{"horizontalScroll":"æ˜¥æ»¡äººé—´","lowerLine":"æ¢…å¼€äº”ç¦æŠ¥æ˜¥æ¥","upperLine":"ç«¹æŠ¥ä¸‰å¤šè¾æ—§å²","appreciation":"æ­¤è”å·§å¦™è¿ç”¨äº†ä¼ ç»Ÿæ–‡åŒ–ä¸­çš„å‰ç¥¥å¯“æ„ï¼Œä¸Šè”'ç«¹æŠ¥ä¸‰å¤šè¾æ—§å²'ä¸­çš„'ä¸‰å¤š'æŒ‡å¤šç¦ã€å¤šå¯¿ã€å¤šå­ï¼Œç«¹å­è±¡å¾èŠ‚èŠ‚é«˜å‡ï¼›ä¸‹è”'æ¢…å¼€äº”ç¦æŠ¥æ˜¥æ¥'ä¸­çš„'äº”ç¦'æŒ‡é•¿å¯¿ã€å¯Œè´µã€åº·å®ã€å¥½å¾·ã€å–„ç»ˆï¼Œæ¢…èŠ±è±¡å¾åšéŸ§ä¸å±ˆã€‚æ¨ªæ‰¹'æ˜¥æ»¡äººé—´'å‘¼åº”äº†æ˜¥å¤©çš„ä¸»é¢˜ã€‚æ•´å‰¯å¯¹è”ä¸ä»…å¯¹ä»—å·¥æ•´ï¼Œæ›´è•´å«ç€æ·±åšçš„æ–‡åŒ–å†…æ¶µå’Œç¾å¥½ç¥æ„¿ã€‚"}
- è¯·ç¡®ä¿ï¼š
  1) åªè¾“å‡ºä¸Šè¿° JSON è¡Œï¼›
  2) æ¯å‰¯å¯¹è”åŒ…å«ä¸Šè”ã€ä¸‹è”ã€æ¨ªæ‰¹ã€èµæï¼›
  3) å­—æ®µåå›ºå®šä¸º horizontalScrollï¼ˆæ¨ªæ‰¹ï¼‰ã€lowerLineï¼ˆä¸‹è”ï¼‰ã€upperLineï¼ˆä¸Šè”ï¼‰ã€appreciationï¼ˆèµæï¼‰ï¼›
  4) å†…å®¹ä¸ºçº¯å¯¹è”æ–‡å­—ï¼Œä¸åŒ…å«"ä¸Šè”ï¼š"ã€"ä¸‹è”ï¼š"ã€"æ¨ªæ‰¹ï¼š"ã€"èµæï¼š"ç­‰å‰ç¼€ï¼›
  5) èµæå†…å®¹ä¸å°‘äº100å­—ï¼Œè¦æœ‰æ–‡åŒ–å†…æ¶µå’Œä¸“ä¸šåˆ†æï¼›
  6) å†…å®¹ç¬¦åˆä¼ ç»Ÿå¯¹è”æ ¼å¾‹è¦æ±‚ã€‚

## æ³¨æ„äº‹é¡¹ï¼ˆé€ä¸€éµå®ˆï¼‰
- æ‰€æœ‰å†…å®¹å¿…é¡»ç¬¦åˆä¸­å›½ä¼ ç»Ÿå¯¹è”æ ¼å¾‹ï¼ŒåŒ…æ‹¬å¹³ä»„ã€å¯¹ä»—ã€æŠ¼éŸµç­‰è¦æ±‚ã€‚
- ç»Ÿä¸€ä½¿ç”¨${getLanguageDisplayName(language)}è¾“å‡ºï¼Œä¸è¦è¾“å‡ºå…¶ä»–è¯­è¨€çš„æç¤ºè¯­ã€è§£é‡Šã€æ ‡é¢˜ã€ç¼–å·ã€åˆ—è¡¨ã€è¡¨æ ¼ã€ä»£ç å—æˆ– Markdown è¯­æ³•ã€‚
- ä¸¥ç¦åœ¨ JSON ä¹‹å¤–è¾“å‡ºä»»ä½•æ–‡æœ¬ï¼ˆåŒ…æ‹¬å¼€åœºç™½ã€æ€»ç»“ã€è‡´è°¢ã€æç¤ºç­‰ï¼‰ï¼›æ¯å‰¯å¯¹è”å¿…é¡»å•ç‹¬å ä¸€è¡Œ JSONã€‚
- ç¦æ­¢æ³„éœ²éšç§ã€ä»‡æ¨ã€æ­§è§†ã€æ­ªæ›²å†å²ç­‰ä¸å½“å†…å®¹ã€‚
`
}

// è§£æå¯¹è”æ–‡æœ¬
export const parseCoupletText = (text: string) => {
  const contents: any[] = []
  const lines = text.split('\n').filter(line => line.trim())

  for (const raw of lines) {
    const line = raw.trim()
    if (!line || line.length > 20000) continue

    // ä¼˜å…ˆå°è¯• JSONL
    try {
      const obj = JSON.parse(line)
      if (obj && typeof obj === 'object') {
        const upperLine = String(obj.upperLine || obj.title || '').trim()
        const lowerLine = String(obj.lowerLine || obj.description || '').trim()
        const horizontalScroll = String(obj.horizontalScroll || obj.startDate || obj.category || '').trim()
        if (upperLine && lowerLine) {
          contents.push({ 
            upperLine, 
            lowerLine, 
            horizontalScroll: horizontalScroll || 'æ¨ªæ‰¹',
            appreciation: String(obj.appreciation || '').trim()
          })
          continue
        }
      }
    } catch (_) {
      // é JSON è¡Œï¼Œå›é€€åˆ° @time@desc è§£æ
    }

    // åŒ¹é…æ ¼å¼ï¼š@æ¨ªæ‰¹@ä¸Šè”@ä¸‹è” æˆ– @æ¨ªæ‰¹@ä¸‹è”ï¼ˆå…¼å®¹æ ¼å¼ï¼‰
    const match = line.match(/@([^@]+)@(.+)/)
    if (match) {
      const [, horizontalScroll, rest] = match
      const parts = rest.split('@')
      if (parts.length >= 2) {
        // @æ¨ªæ‰¹@ä¸Šè”@ä¸‹è”
        contents.push({ 
          upperLine: parts[0].trim(), 
          lowerLine: parts[1].trim(), 
          horizontalScroll: horizontalScroll.trim(),
          appreciation: ''
        })
      } else {
        // @æ¨ªæ‰¹@ä¸‹è”ï¼ˆä¸Šè”ä¸ºç©ºï¼‰
        contents.push({ 
          upperLine: '', 
          lowerLine: rest.trim(), 
          horizontalScroll: horizontalScroll.trim(),
          appreciation: ''
        })
      }
    }
  }

  return contents
}

// è§£æAIè¿”å›çš„åˆ†ç±»å’Œæ ‡ç­¾JSON
const parseClassificationResult = (text: string) => {
  try {
    // æå–JSONéƒ¨åˆ†
    const jsonMatch = text.match(/\{[\s\S]*\}/)
    if (!jsonMatch) {
      throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONæ ¼å¼')
    }

    const result = JSON.parse(jsonMatch[0])

    // éªŒè¯å¿…è¦å­—æ®µ
    if (!result.category || !result.tags) {
      throw new Error('JSONæ ¼å¼ä¸å®Œæ•´')
    }

    return result
  } catch (error) {
    console.error('è§£æåˆ†ç±»ç»“æœå¤±è´¥:', error)
    // è¿”å›é»˜è®¤åˆ†ç±»
    return {
      category: {
        name: 'AIç”Ÿæˆ',
        slug: 'ai-generated',
        description: 'ç”±AIæ™ºèƒ½ç”Ÿæˆçš„æ—¶é—´çº¿',
        icon: 'ğŸ¤–',
        color: '#6366f1',
        isNew: false,
      },
      tags: [
        {
          name: 'AIç”Ÿæˆ',
          slug: 'ai-generated',
          color: '#6366f1',
        },
      ],
    }
  }
}

// ç”Ÿæˆåˆ†ç±»å’Œæ ‡ç­¾
export async function generateClassification(
  prompt: string,
  events: any[],
  model: string = 'deepseek-chat',
  language: string = 'en',
) {
  try {
    // é€‰æ‹©AIæ¨¡å‹
    let aiModel
    if (GROQ_MODELS.includes(model)) {
      aiModel = groq(model)
    } else if (DEEPSEEK_MODELS.includes(model)) {
      aiModel = deepseek(model)
    } else {
      aiModel = deepseek('deepseek-chat')
    }

    // ç”Ÿæˆåˆ†ç±»å’Œæ ‡ç­¾
    const result = await streamText({
      model: aiModel,
      prompt: generateClassificationPrompt(prompt, events, language),
    })

    // æ”¶é›†å®Œæ•´å“åº”
    let fullText = ''
    for await (const chunk of result.textStream) {
      fullText += chunk
    }

    // è§£æç»“æœ
    const classification = parseClassificationResult(fullText)

    return {
      success: true,
      data: classification,
    }
  } catch (error) {
    console.error('AIåˆ†ç±»ç”Ÿæˆå¤±è´¥:', error)
    return {
      success: false,
      error: 'åˆ†ç±»ç”Ÿæˆå¤±è´¥',
      data: {
        category: {
          name: 'AIç”Ÿæˆ',
          slug: 'ai-generated',
          description: 'ç”±AIæ™ºèƒ½ç”Ÿæˆçš„æ—¶é—´çº¿',
          icon: 'ğŸ¤–',
          color: '#6366f1',
          isNew: false,
        },
        tags: [
          {
            name: 'AIç”Ÿæˆ',
            slug: 'ai-generated',
            color: '#6366f1',
          },
        ],
      },
    }
  }
}

// æ™ºèƒ½åˆ†ç±»æ˜ å°„ï¼ˆåŸºäºå…³é”®è¯çš„å¿«é€Ÿåˆ†ç±»ï¼‰
export function quickClassify(prompt: string, events: any[]): {
  category: { name: string; slug: string; icon: string; color: string };
  tags: string[];
} {
  const text = (`${prompt} ${events.map(e => e.description).join(' ')}`).toLowerCase()

  // åˆ†ç±»å…³é”®è¯æ˜ å°„
  const categoryKeywords = {
    'å†å²äººç‰©': {
      keywords: ['äººç‰©', 'ç”Ÿå¹³', 'ä¼ è®°', 'å‡ºç”Ÿ', 'å»ä¸–', 'çš‡å¸', 'å°†å†›', 'è¯—äºº', 'ä½œå®¶', 'ç§‘å­¦å®¶', 'æ”¿æ²»å®¶', 'é¢†è¢–', 'åäºº'],
      icon: 'ğŸ‘¤',
      color: '#3b82f6',
    },
    'å†å²äº‹ä»¶': {
      keywords: ['æˆ˜äº‰', 'é©å‘½', 'èµ·ä¹‰', 'æ”¿å˜', 'äº‹ä»¶', 'æˆ˜å½¹', 'å†²çª', 'æ”¹é©', 'å˜é©', 'è¿åŠ¨'],
      icon: 'âš”ï¸',
      color: '#ef4444',
    },
    'ç§‘æŠ€å‘å±•': {
      keywords: ['å‘æ˜', 'æŠ€æœ¯', 'ç§‘æŠ€', 'åˆ›æ–°', 'ä¸“åˆ©', 'ç§‘å­¦', 'ç ”ç©¶', 'å®éªŒ', 'è®¡ç®—æœº', 'äº’è”ç½‘', 'äººå·¥æ™ºèƒ½', 'æœºå™¨äºº'],
      icon: 'ğŸ”¬',
      color: '#10b981',
    },
    'æ–‡åŒ–è‰ºæœ¯': {
      keywords: ['æ–‡å­¦', 'è‰ºæœ¯', 'éŸ³ä¹', 'ç”µå½±', 'ç»˜ç”»', 'é›•å¡‘', 'å»ºç­‘', 'æ–‡åŒ–', 'è¯—æ­Œ', 'å°è¯´', 'æˆå‰§', 'èˆè¹ˆ'],
      icon: 'ğŸ¨',
      color: '#8b5cf6',
    },
    'æ”¿æ²»åˆ¶åº¦': {
      keywords: ['æ”¿æ²»', 'åˆ¶åº¦', 'æ”¿æƒ', 'æ”¿åºœ', 'æ³•å¾‹', 'å®ªæ³•', 'é€‰ä¸¾', 'æ°‘ä¸»', 'ä¸“åˆ¶', 'è®®ä¼š'],
      icon: 'ğŸ›ï¸',
      color: '#f59e0b',
    },
    'ç»æµè´¸æ˜“': {
      keywords: ['ç»æµ', 'è´¸æ˜“', 'å•†ä¸š', 'é‡‘è', 'è´§å¸', 'å¸‚åœº', 'å…¬å¸', 'è‚¡ç¥¨', 'é“¶è¡Œ', 'æŠ•èµ„'],
      icon: 'ğŸ’°',
      color: '#06b6d4',
    },
    'åœ°ç†æ¢ç´¢': {
      keywords: ['åœ°ç†', 'æ¢é™©', 'å‘ç°', 'èˆªæµ·', 'åœ°å›¾', 'é¢†åœŸ', 'æ®–æ°‘', 'æ–°å¤§é™†'],
      icon: 'ğŸ—ºï¸',
      color: '#84cc16',
    },
    'ç¤¾ä¼šå˜è¿': {
      keywords: ['ç¤¾ä¼š', 'é£ä¿—', 'ä¹ æƒ¯', 'ç”Ÿæ´»æ–¹å¼', 'ç¤¾ä¼šåˆ¶åº¦', 'é˜¶çº§', 'å¹³ç­‰', 'æƒåˆ©'],
      icon: 'ğŸ˜ï¸',
      color: '#f97316',
    },
    'å†›äº‹æˆ˜äº‰': {
      keywords: ['å†›äº‹', 'æˆ˜äº‰', 'å†›é˜Ÿ', 'æ­¦å™¨', 'æˆ˜ç•¥', 'æˆ˜æœ¯', 'å£«å…µ', 'å°†å†›', 'å…ƒå¸…'],
      icon: 'ğŸ–ï¸',
      color: '#dc2626',
    },
    'å®—æ•™å“²å­¦': {
      keywords: ['å®—æ•™', 'å“²å­¦', 'ä¿¡ä»°', 'æ•™æ´¾', 'æ€æƒ³', 'ç†è®º', 'ç¥å­¦', 'ä½›æ•™', 'åŸºç£æ•™', 'ä¼Šæ–¯å…°æ•™'],
      icon: 'â›ª',
      color: '#7c3aed',
    },
    'æ•™è‚²å­¦æœ¯': {
      keywords: ['æ•™è‚²', 'å­¦æœ¯', 'å­¦æ ¡', 'å¤§å­¦', 'ç ”ç©¶', 'çŸ¥è¯†', 'å­¦ä¹ ', 'æ•™æˆ', 'å­¦è€…'],
      icon: 'ğŸ“š',
      color: '#059669',
    },
    'ä½“è‚²ç«æŠ€': {
      keywords: ['ä½“è‚²', 'ç«æŠ€', 'è¿åŠ¨', 'æ¯”èµ›', 'å¥¥è¿ä¼š', 'ä¸–ç•Œæ¯', 'è¶³çƒ', 'ç¯®çƒ', 'ç½‘çƒ'],
      icon: 'âš½',
      color: '#ea580c',
    },
    'åŒ»å­¦å¥åº·': {
      keywords: ['åŒ»å­¦', 'å¥åº·', 'ç–¾ç—…', 'æ²»ç–—', 'åŒ»é™¢', 'è¯ç‰©', 'åŒ»ç”Ÿ', 'æŠ¤å£«', 'ç–«è‹—'],
      icon: 'ğŸ¥',
      color: '#0891b2',
    },
    'ç¯å¢ƒè‡ªç„¶': {
      keywords: ['ç¯å¢ƒ', 'è‡ªç„¶', 'æ°”å€™', 'ç”Ÿæ€', 'æ±¡æŸ“', 'ä¿æŠ¤', 'åŠ¨ç‰©', 'æ¤ç‰©', 'æ£®æ—'],
      icon: 'ğŸŒ',
      color: '#16a34a',
    },
    'å¨±ä¹ä¼‘é—²': {
      keywords: ['å¨±ä¹', 'æ¸¸æˆ', 'ä¼‘é—²', 'ç”µå½±', 'ç”µè§†', 'ç»¼è‰º', 'æ˜æ˜Ÿ', 'å¶åƒ', 'æµè¡Œ'],
      icon: 'ğŸ®',
      color: '#ec4899',
    },
    'äº¤é€šé€šä¿¡': {
      keywords: ['äº¤é€š', 'é€šä¿¡', 'è¿è¾“', 'ç½‘ç»œ', 'æ‰‹æœº', 'æ±½è½¦', 'é£æœº', 'ç«è½¦', 'äº’è”ç½‘'],
      icon: 'ğŸš—',
      color: '#8b5a2b',
    },
    'å·¥ä¸šåˆ¶é€ ': {
      keywords: ['å·¥ä¸š', 'åˆ¶é€ ', 'ç”Ÿäº§', 'å·¥å‚', 'æœºå™¨', 'è‡ªåŠ¨åŒ–', 'å·¥ä¸šé©å‘½', 'åˆ¶é€ ä¸š'],
      icon: 'ğŸ­',
      color: '#6b7280',
    },
    'å†œä¸šé£Ÿå“': {
      keywords: ['å†œä¸š', 'é£Ÿå“', 'ç§æ¤', 'å…»æ®–', 'ç²®é£Ÿ', 'è”¬èœ', 'æ°´æœ', 'å†œä¸šé©å‘½'],
      icon: 'ğŸŒ¾',
      color: '#22c55e',
    },
    'å»ºç­‘åŸå¸‚': {
      keywords: ['å»ºç­‘', 'åŸå¸‚', 'è§„åˆ’', 'åŸå¸‚åŒ–', 'æ‘©å¤©å¤§æ¥¼', 'åŸå¸‚è§„åˆ’', 'å»ºç­‘é£æ ¼'],
      icon: 'ğŸ™ï¸',
      color: '#fbbf24',
    },
    'ä¸ªäººç”Ÿæ´»': {
      keywords: ['ä¸ªäºº', 'ç”Ÿæ´»', 'ç»å†', 'æˆé•¿', 'æ•…äº‹', 'å›å¿†', 'äººç”Ÿ', 'å®¶åº­'],
      icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦',
      color: '#f59e0b',
    },
    'ä¼ä¸šå‘å±•': {
      keywords: ['ä¼ä¸š', 'å…¬å¸', 'å•†ä¸š', 'å‘å±•', 'åˆ›ä¸š', 'ç®¡ç†', 'å“ç‰Œ', 'å¸‚åœº'],
      icon: 'ğŸ¢',
      color: '#3b82f6',
    },
    'äº§å“å‘å±•': {
      keywords: ['äº§å“', 'æŠ€æœ¯', 'è¿­ä»£', 'ç‰ˆæœ¬', 'æ›´æ–°', 'å‘å¸ƒ', 'å¸‚åœº', 'ç”¨æˆ·'],
      icon: 'ğŸ“±',
      color: '#10b981',
    },
    'ç¤¾ä¼šç°è±¡': {
      keywords: ['ç¤¾ä¼š', 'ç°è±¡', 'è¶‹åŠ¿', 'æ–‡åŒ–', 'æµè¡Œ', 'æ—¶å°š', 'æ½®æµ', 'å˜åŒ–'],
      icon: 'ğŸ“Š',
      color: '#8b5cf6',
    },
  }

  // æŸ¥æ‰¾åŒ¹é…çš„åˆ†ç±»
  let bestMatch = {
    name: 'AIç”Ÿæˆ',
    slug: 'ai-generated',
    icon: 'ğŸ¤–',
    color: '#6366f1',
    score: 0,
  }

  for (const [categoryName, config] of Object.entries(categoryKeywords)) {
    const score = config.keywords.filter(keyword => text.includes(keyword)).length
    if (score > bestMatch.score) {
      bestMatch = {
        name: categoryName,
        slug: categoryName.toLowerCase().replace(/\s+/g, '-'),
        icon: config.icon,
        color: config.color,
        score,
      }
    }
  }

  // ç”Ÿæˆæ ‡ç­¾
  const tags = []
  if (bestMatch.score > 0) {
    tags.push(bestMatch.name)
  }

  // æ·»åŠ ä¸€äº›é€šç”¨æ ‡ç­¾
  if (text.includes('ä¸­å›½') || text.includes('ä¸­å')) tags.push('ä¸­å›½å†å²')
  if (text.includes('å¤ä»£') || text.includes('å¤ä»£')) tags.push('å¤ä»£')
  if (text.includes('ç°ä»£') || text.includes('ç°ä»£')) tags.push('ç°ä»£')
  if (text.includes('è¿‘ä»£') || text.includes('è¿‘ä»£')) tags.push('è¿‘ä»£')
  if (text.includes('ä¸–ç•Œ') || text.includes('ä¸–ç•Œ')) tags.push('ä¸–ç•Œå†å²')
  if (text.includes('ç¾å›½')) tags.push('ç¾å›½å†å²')
  if (text.includes('æ¬§æ´²')) tags.push('æ¬§æ´²å†å²')
  if (text.includes('äºšæ´²')) tags.push('äºšæ´²å†å²')

  return {
    category: {
      name: bestMatch.name,
      slug: bestMatch.slug,
      icon: bestMatch.icon,
      color: bestMatch.color,
    },
    tags: tags.slice(0, 5), // é™åˆ¶æ ‡ç­¾æ•°é‡
  }
}

const slugify = (s: string) => s.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')

export async function generateMetaFromPrompt(prompt: string, model: string = 'deepseek-chat', language: string = 'en') {
  let aiModel: any
  if (GROQ_MODELS.includes(model)) aiModel = groq(model)
  else if (DEEPSEEK_MODELS.includes(model)) aiModel = deepseek(model)
  else aiModel = deepseek('deepseek-chat')

  const system = `ä½ æ˜¯ä¸€ä¸ªæ—¶é—´çº¿çš„å…ƒä¿¡æ¯ç”ŸæˆåŠ©æ‰‹ã€‚ä»…æ ¹æ®ç”¨æˆ·çš„æç¤ºè¯ï¼Œç»™å‡ºä¸€å¥ç®€ä»‹ï¼ˆçº¦100-150å­—ï¼‰ã€ä¸€ä¸ªæœ€åˆé€‚çš„åˆ†ç±»ï¼Œä»¥åŠ3-5ä¸ªç›¸å…³æ ‡ç­¾ã€‚è¾“å‡ºè¦ç»“æ„åŒ–ã€ç®€æ´ï¼Œå¹¶ä½¿ç”¨${getLanguageDisplayName(language)}ã€‚åˆ†ç±»ä¸æ ‡ç­¾æä¾› slugï¼ˆå°å†™è‹±æ–‡ã€è¿å­—ç¬¦ï¼‰ã€‚åªè¾“å‡ºä¸€ä¸ª JSON å¯¹è±¡ï¼Œä¸èƒ½æœ‰ä»»ä½•è§£é‡Šã€å‰åç¼€æˆ–é¢å¤–æ–‡æœ¬ã€‚`

  const user = `ç”¨æˆ·æç¤ºè¯ï¼š${prompt}\n\nè¯·ä¸¥æ ¼è¾“å‡ºå¦‚ä¸‹ JSON ç»“æ„ï¼š{ "description": "...", "category": { "name": "...", "slug": "...", "description": "...", "icon": "...", "color": "...", "isNew": false }, "tags": [{ "name": "...", "slug": "...", "color": "..." }] }`

  try {
    const result = await streamText({
      model: aiModel,
      prompt: `${system}\n\n${user}`,
      temperature: 0.3,
      maxTokens: 700,
    })

    let full = ''
    for await (const chunk of result.textStream) full += chunk
    const jsonMatch = full.match(/\{[\s\S]*\}$/)
    if (!jsonMatch) throw new Error('No JSON found in response')

    const parsed: any = JSON.parse(jsonMatch[0])

    const description: string = typeof parsed.description === 'string'
      ? parsed.description.slice(0, 180)
      : String(prompt).slice(0, 150)

    const rawCategory: any = parsed.category || {}
    const categoryName: string = String(rawCategory.name || 'AIç”Ÿæˆ')
    const category = {
      name: categoryName,
      slug: rawCategory.slug ? String(rawCategory.slug) : slugify(categoryName),
      description: typeof rawCategory.description === 'string' ? rawCategory.description : 'ç”±AIæ™ºèƒ½ç”Ÿæˆçš„æ—¶é—´çº¿',
      icon: typeof rawCategory.icon === 'string' ? rawCategory.icon : 'ğŸ¤–',
      color: typeof rawCategory.color === 'string' ? rawCategory.color : '#6366f1',
      isNew: Boolean(rawCategory.isNew || false),
    }

    const tagsArray: any[] = Array.isArray(parsed.tags) ? parsed.tags.slice(0, 5) : []
    const tags = tagsArray.map((t: any) => {
      const name = String((t && t.name) || 'AIç”Ÿæˆ')
      return {
        name,
        slug: t && t.slug ? String(t.slug) : slugify(name),
        color: t && typeof t.color === 'string' ? t.color : undefined,
      }
    })

    return {
      success: true,
      data: {
        description,
        category,
        tags,
      },
    }
  } catch (error: any) {
    return {
      success: false,
      error: 'å…ƒä¿¡æ¯ç”Ÿæˆå¤±è´¥',
      detail: error?.message || 'unknown error',
      data: {
        description: String(prompt).slice(0, 150),
        category: {
          name: 'AIç”Ÿæˆ',
          slug: 'ai-generated',
          description: 'ç”±AIæ™ºèƒ½ç”Ÿæˆçš„æ—¶é—´çº¿',
          icon: 'ğŸ¤–',
          color: '#6366f1',
          isNew: false,
        },
        tags: [],
      },
    }
  }
}

export async function generateComicMetaFromPrompt(prompt: string, model: string = 'deepseek-chat', language: string = 'en') {
  let aiModel: any
  if (GROQ_MODELS.includes(model)) aiModel = groq(model)
  else if (DEEPSEEK_MODELS.includes(model)) aiModel = deepseek(model)
  else aiModel = deepseek('deepseek-chat')

  const system = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç­–åˆ’å¸ˆå’Œç¼–å‰§ã€‚æ ¹æ®ç”¨æˆ·çš„åˆ›æ„æç¤ºè¯ï¼Œä¸ºæ¼«ç”»ä½œå“ç”Ÿæˆå®Œæ•´çš„åˆ›ä½œæ–¹æ¡ˆï¼š

1. æ¼«ç”»åŸºæœ¬ä¿¡æ¯ï¼š
   - å¸å¼•äººçš„æ¼«ç”»åç§°ï¼ˆæ ‡é¢˜ï¼‰
   - ç²¾å½©çš„æ¼«ç”»æ•…äº‹ç®€ä»‹ï¼ˆ100-150å­—ï¼‰
   - æœ€åˆé€‚çš„æ¼«ç”»åˆ†ç±»ï¼ˆå¦‚å†’é™©ã€çˆ±æƒ…ã€ç§‘å¹»ã€æç¬‘ã€æ‚¬ç–‘ã€æ ¡å›­ã€å¥‡å¹»ã€åŠ¨ä½œã€æ²»æ„ˆã€ææ€–ç­‰ï¼‰
   - 3-5ä¸ªç›¸å…³æ ‡ç­¾
   - æœ€é€‚åˆçš„æ¼«ç”»é£æ ¼ï¼ˆå¦‚animeåŠ¨æ¼«é£ã€realisticå†™å®é£ã€cartoonå¡é€šé£ã€watercoloræ°´å½©é£ã€sketchç´ æé£ã€chibièŒç³»é£ç­‰ï¼‰

2. æ¼«ç”»å®Œæ•´å·ç»“æ„ï¼š
   - æ ¹æ®æ•…äº‹å†…å®¹ï¼Œè§„åˆ’åˆç†çš„å·æ•°ï¼ˆé€šå¸¸1-3å·ï¼‰
   - æ¯å·åŒ…å«ï¼š
     * å·æ ‡é¢˜ï¼ˆå¸å¼•äººçš„æ ‡é¢˜ï¼‰
     * å·ç®€ä»‹ï¼ˆ80-120å­—ï¼Œæè¿°è¿™ä¸€å·çš„ä¸»è¦æ•…äº‹å†…å®¹å’Œå‘å±•ï¼‰
     * å·ä¸­çš„è¯æ•°ï¼ˆæ¯å·é€šå¸¸åŒ…å«3-8è¯ï¼‰
   - æ¯è¯åŒ…å«ï¼š
     * è¯æ ‡é¢˜ï¼ˆå…·ä½“çš„ç« èŠ‚æ ‡é¢˜ï¼‰
     * è¯ç®€ä»‹ï¼ˆ50-80å­—ï¼Œæè¿°è¿™ä¸€è¯çš„å…·ä½“å†…å®¹ï¼‰
     * 4-6ä¸ªè¿ç»­çš„æ¼«ç”»åˆ†é•œ

3. åˆ†é•œè¯¦ç»†ä¿¡æ¯ï¼š
æ¯ä¸ªåˆ†é•œåŒ…å«å®Œæ•´ä¿¡æ¯ï¼š
     * ç”»é¢æè¿°ï¼ˆè¯¦ç»†çš„åœºæ™¯ã€äººç‰©ã€åŠ¨ä½œã€è¡¨æƒ…ç­‰ï¼Œé€‚åˆAIç»˜ç”»æ¨¡å‹ç†è§£ï¼‰
     * å¯¹è¯å†…å®¹ï¼ˆè§’è‰²è¯´çš„è¯ï¼Œå¦‚æœæ²¡æœ‰å¯¹è¯å°±ç•™ç©ºï¼‰
     * æ—ç™½å†…å®¹ï¼ˆæ•…äº‹å™è¿°æˆ–å¿ƒç†æè¿°ï¼‰
     * æƒ…æ„Ÿæ°›å›´ï¼ˆå¦‚ç´§å¼ ã€æ¸©é¦¨ã€æ¿€åŠ¨ã€æ‚²ä¼¤ã€æç¬‘ã€ç¥ç§˜ç­‰ï¼‰
     * é•œå¤´è§’åº¦ï¼ˆå¦‚è¿‘æ™¯ã€è¿œæ™¯ã€ç‰¹å†™ã€ä¿¯è§†ã€ä»°è§†ã€ä¾§é¢ã€æ­£é¢ç­‰ï¼‰
     * è§’è‰²ä¿¡æ¯ï¼ˆå‡ºç°çš„è§’è‰²åç§°å’ŒçŠ¶æ€ï¼‰

ã€é‡è¦ã€‘è§’è‰²ä¸€è‡´æ€§è¦æ±‚ï¼š
- æ‰€æœ‰è§’è‰²ï¼ˆä¸»è§’ã€é…è§’ã€æ¬¡è¦è§’è‰²ï¼‰çš„æ€§åˆ«ã€å¤–è²Œã€æ€§æ ¼å¿…é¡»åœ¨æ•´ä¸ªæ¼«ç”»ä¸­ä¿æŒå®Œå…¨ä¸€è‡´
- å¦‚æœæŸä¸ªè§’è‰²åœ¨é¦–æ¬¡å‡ºç°æ—¶æ˜¯å¥³æ€§ï¼Œé‚£ä¹ˆåœ¨æ‰€æœ‰åç»­åˆ†é•œä¸­éƒ½å¿…é¡»æ˜¯å¥³æ€§
- å¦‚æœæŸä¸ªè§’è‰²åœ¨é¦–æ¬¡å‡ºç°æ—¶æ˜¯ç”·æ€§ï¼Œé‚£ä¹ˆåœ¨æ‰€æœ‰åç»­åˆ†é•œä¸­éƒ½å¿…é¡»æ˜¯ç”·æ€§
- ä¸¥ç¦åœ¨æ•…äº‹ä¸­é€”æ”¹å˜ä»»ä½•è§’è‰²çš„æ€§åˆ«ã€åŸºæœ¬å¤–è²Œç‰¹å¾æˆ–æ ¸å¿ƒæ€§æ ¼
- æ¯ä¸ªåˆ†é•œçš„ç”»é¢æè¿°ä¸­éƒ½è¦æ˜ç¡®æŒ‡å‡ºæ‰€æœ‰å‡ºç°è§’è‰²çš„æ€§åˆ«å’Œå¤–è²Œç‰¹å¾
- ä¸ºæ¯ä¸ªè§’è‰²å»ºç«‹æ¸…æ™°çš„è®¾å®šæ¡£æ¡ˆï¼ŒåŒ…æ‹¬æ€§åˆ«ã€å¹´é¾„ã€å¤–è²Œã€æœè£…ã€æ€§æ ¼ç­‰
- ç¡®ä¿æ‰€æœ‰è§’è‰²è®¾å®šå‰åå‘¼åº”ï¼Œé¿å…å‡ºç°æ€§åˆ«æ··ä¹±æˆ–è§’è‰²é”™ä½
- ç‰¹åˆ«æ³¨æ„ï¼šåŒä¸€ä¸ªè§’è‰²ä¸èƒ½åœ¨ä¸åŒåˆ†é•œä¸­å˜æˆä¸åŒæ€§åˆ«çš„äºº

ã€å†…å®¹å¥åº·è¦æ±‚ã€‘ï¼š
- æ‰€æœ‰å†…å®¹å¿…é¡»å¥åº·å‘ä¸Šï¼Œé€‚åˆå…¨å¹´é¾„æ®µè§‚çœ‹
- ä¸¥ç¦åŒ…å«æš´åŠ›ã€è‰²æƒ…ã€ææ€–ã€è¡€è…¥ç­‰ä¸å½“å†…å®¹
- æ•…äº‹æƒ…èŠ‚è¦ç§¯ææ­£é¢ï¼Œä¼ é€’æ­£èƒ½é‡
- è§’è‰²å…³ç³»è¦å¥åº·çº¯æ´ï¼Œé¿å…ä¸å½“æš—ç¤º

è¦æ±‚ï¼š
- æ•…äº‹è¦æœ‰å®Œæ•´çš„èµ·æ‰¿è½¬åˆ
- æ¯å·è¦æœ‰æ˜ç¡®çš„ä¸»é¢˜å’Œå‘å±•è„‰ç»œ
- åˆ†é•œè¦è¿è´¯ï¼Œèƒ½å¤Ÿæ¸…æ™°åœ°è®²è¿°æ•…äº‹
- å¯¹è¯è¦è‡ªç„¶ï¼Œç¬¦åˆè§’è‰²æ€§æ ¼
- ç”»é¢æè¿°è¦è¯¦ç»†ï¼Œä¾¿äºAIç†è§£å’Œç”Ÿæˆå›¾åƒ
- ä¸¥æ ¼ä¿æŒè§’è‰²ä¸€è‡´æ€§ï¼Œç‰¹åˆ«æ˜¯ä¸»è§’çš„æ€§åˆ«å’Œå¤–è²Œ

è¾“å‡ºè¦ç»“æ„åŒ–ã€ç®€æ´ï¼Œå¹¶ä½¿ç”¨${getLanguageDisplayName(language)}ã€‚åˆ†ç±»ä¸æ ‡ç­¾æä¾› slugï¼ˆå°å†™è‹±æ–‡ã€è¿å­—ç¬¦ï¼‰ã€‚åªè¾“å‡ºä¸€ä¸ª JSON å¯¹è±¡ï¼Œä¸èƒ½æœ‰ä»»ä½•è§£é‡Šã€å‰åç¼€æˆ–é¢å¤–æ–‡æœ¬ã€‚`

  const user = `ç”¨æˆ·åˆ›æ„æç¤ºè¯ï¼š${prompt}

ã€é‡è¦ã€‘ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è¦æ±‚è¾“å‡ºï¼š
1. åªè¾“å‡ºä¸€ä¸ªå®Œæ•´çš„JSONå¯¹è±¡
2. ä¸è¦æ·»åŠ ä»»ä½•markdownæ ‡è®°ï¼ˆå¦‚\`\`\`jsonï¼‰
3. ä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ–‡å­—
4. ç¡®ä¿JSONæ ¼å¼å®Œå…¨æ­£ç¡®
5. ä½¿ç”¨è‹±æ–‡æ ‡ç‚¹ç¬¦å·
6. ç¡®ä¿æ‰€æœ‰æ‹¬å·å’Œå¼•å·æ­£ç¡®é—­åˆ

JSONæ ¼å¼ï¼š
{
  "title": "æ¼«ç”»æ ‡é¢˜",
  "description": "æ¼«ç”»ç®€ä»‹",
  "style": "anime",
  "category": {
    "name": "åˆ†ç±»åç§°",
    "slug": "category-slug", 
    "description": "åˆ†ç±»æè¿°",
    "icon": "ğŸ¨",
    "color": "#8b5cf6",
    "isNew": false
  },
  "tags": [
    {
      "name": "æ ‡ç­¾1",
      "slug": "tag1-slug",
      "color": "#8b5cf6"
    }
  ],
  "volumes": [
    {
      "title": "ç¬¬1å·",
      "description": "ç¬¬1å·ç®€ä»‹",
      "episodes": [
        {
          "title": "ç¬¬1è¯", 
          "description": "ç¬¬1è¯ç®€ä»‹",
          "panels": [
            {
              "panelNumber": 1,
              "sceneDescription": "åˆ†é•œ1ç”»é¢æè¿°",
              "dialogue": "å¯¹è¯1",
              "narration": "æ—ç™½1",
              "emotion": "æƒ…æ„Ÿ1",
              "cameraAngle": "è§’åº¦1",
              "characters": "è§’è‰²1"
            },
            {
              "panelNumber": 2,
              "sceneDescription": "åˆ†é•œ2ç”»é¢æè¿°", 
              "dialogue": "å¯¹è¯2",
              "narration": "æ—ç™½2",
              "emotion": "æƒ…æ„Ÿ2",
              "cameraAngle": "è§’åº¦2",
              "characters": "è§’è‰²2"
            },
            {
              "panelNumber": 3,
              "sceneDescription": "åˆ†é•œ3ç”»é¢æè¿°",
              "dialogue": "å¯¹è¯3", 
              "narration": "æ—ç™½3",
              "emotion": "æƒ…æ„Ÿ3",
              "cameraAngle": "è§’åº¦3",
              "characters": "è§’è‰²3"
            },
            {
              "panelNumber": 4,
              "sceneDescription": "åˆ†é•œ4ç”»é¢æè¿°",
              "dialogue": "å¯¹è¯4",
              "narration": "æ—ç™½4",
              "emotion": "æƒ…æ„Ÿ4",
              "cameraAngle": "è§’åº¦4",
              "characters": "è§’è‰²4"
            }
          ]
        }
      ]
    }
  ]
}`

  try {
    console.log('å¼€å§‹è°ƒç”¨DeepSeekç”Ÿæˆæ¼«ç”»å†…å®¹...')
    const result = await streamText({
      model: aiModel,
      prompt: `${system}\n\n${user}`,
      temperature: 0.8,
      maxTokens: 4000, // å¢åŠ tokené™åˆ¶ï¼Œå› ä¸ºéœ€è¦æ›´å¤šå†…å®¹
    })

    let full = ''
    for await (const chunk of result.textStream) {
      full += chunk
    }
    
    console.log('DeepSeekå“åº”é•¿åº¦:', full.length)
    console.log('DeepSeekå“åº”å‰500å­—ç¬¦:', full.substring(0, 500))
    
    // æ›´çµæ´»çš„JSONæå–é€»è¾‘
    let jsonMatch = full.match(/\{[\s\S]*\}/)
    if (!jsonMatch) {
      // å°è¯•æŸ¥æ‰¾ç¬¬ä¸€ä¸ª{åˆ°æœ€åä¸€ä¸ª}
      const firstBrace = full.indexOf('{')
      const lastBrace = full.lastIndexOf('}')
      if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
        const jsonStr = full.substring(firstBrace, lastBrace + 1)
        jsonMatch = [jsonStr]
      }
    }
    
    if (!jsonMatch) {
      console.error('æ— æ³•ä»å“åº”ä¸­æå–JSON:', full)
      throw new Error('No JSON found in response')
    }

    console.log('æå–çš„JSONå­—ç¬¦ä¸²é•¿åº¦:', jsonMatch[0].length)
    
    // æ¸…ç†å’Œä¿®å¤JSONå­—ç¬¦ä¸²
    let jsonStr = jsonMatch[0]
    // ç§»é™¤å¯èƒ½çš„markdownä»£ç å—æ ‡è®°
    jsonStr = jsonStr.replace(/```json\s*/g, '').replace(/```\s*/g, '')
    // ç§»é™¤å¤šä½™çš„æ¢è¡Œå’Œç©ºæ ¼
    jsonStr = jsonStr.trim()
    
    let parsed: any
    try {
      parsed = JSON.parse(jsonStr)
    } catch (parseError) {
      console.error('JSONè§£æå¤±è´¥:', parseError)
      console.error('é”™è¯¯ä½ç½®é™„è¿‘çš„å†…å®¹:', jsonStr.substring(Math.max(0, 9640), 9670))
      
      // å°è¯•ä¿®å¤å¸¸è§çš„JSONé”™è¯¯
      try {
        // ç§»é™¤å°¾éšé€—å·
        let fixedJson = jsonStr.replace(/,(\s*[}\]])/g, '$1')
        // ä¿®å¤æœªé—­åˆçš„å¼•å·å’Œè½¬ä¹‰å­—ç¬¦
        fixedJson = fixedJson.replace(/([^"\\])"([^",:}\]\s])/g, '$1\\"$2')
        // ç§»é™¤å¯èƒ½çš„é‡å¤é€—å·
        fixedJson = fixedJson.replace(/,,+/g, ',')
        
        parsed = JSON.parse(fixedJson)
        console.log('JSONä¿®å¤æˆåŠŸ')
      } catch (secondError) {
        console.error('JSONä¿®å¤ä¹Ÿå¤±è´¥:', secondError)
        // è¿”å›é»˜è®¤ç»“æ„è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯
        parsed = {
          title: prompt,
          description: `ä¸€ä¸ªå…³äº${prompt}çš„ç²¾å½©æ¼«ç”»æ•…äº‹`,
          style: 'anime',
          category: {
            name: 'AIç”Ÿæˆ',
            slug: 'ai-generated',
            description: 'ç”±AIæ™ºèƒ½ç”Ÿæˆçš„æ¼«ç”»ä½œå“',
            icon: 'ğŸ¨',
            color: '#8b5cf6',
            isNew: false,
          },
          tags: [],
          volumes: [
            {
              title: 'ç¬¬1å·',
              description: 'æ•…äº‹å¼€å§‹...',
              episodes: [
                {
                  title: 'ç¬¬1è¯',
                  description: 'æ•…äº‹å¼€å§‹...',
                  panels: []
                }
              ]
            }
          ]
        }
        console.log('ä½¿ç”¨é»˜è®¤JSONç»“æ„')
      }
    }

    const title = parsed.title || prompt
    const description = parsed.description || `ä¸€ä¸ªå…³äº${prompt}çš„ç²¾å½©æ¼«ç”»æ•…äº‹`
    const style = parsed.style || 'anime'
    
    // å¤„ç†å·ç»“æ„
    const volumes = Array.isArray(parsed.volumes) ? parsed.volumes.map((vol: any, volIndex: number) => ({
      title: vol.title || `ç¬¬${volIndex + 1}å·`,
      description: vol.description || 'ç²¾å½©çš„æ•…äº‹å¼€å§‹...',
      episodes: Array.isArray(vol.episodes) ? vol.episodes.map((ep: any, epIndex: number) => ({
        title: ep.title || `ç¬¬${epIndex + 1}è¯`,
        description: ep.description || 'æ•…äº‹ç»§ç»­...',
        panels: Array.isArray(ep.panels) ? ep.panels.map((panel: any, panelIndex: number) => ({
          panelNumber: panel.panelNumber || (panelIndex + 1),
          sceneDescription: panel.sceneDescription || panel.description || 'åœºæ™¯æè¿°',
          dialogue: panel.dialogue || '',
          narration: panel.narration || '',
          emotion: panel.emotion || 'å¹³é™',
          cameraAngle: panel.cameraAngle || 'æ­£é¢è§†è§’',
          characters: panel.characters || 'ä¸»è§’'
        })) : []
      })) : []
    })) : [
      {
        title: 'ç¬¬1å·',
        description: 'æ•…äº‹å¼€å§‹...',
        episodes: [
          {
            title: 'ç¬¬1è¯',
            description: 'æ•…äº‹å¼€å§‹...',
            panels: []
          }
        ]
      }
    ]

    const rawCategory = parsed.category || {}
    const categoryName = rawCategory.name || 'AIç”Ÿæˆ'
    const category = {
      name: categoryName,
      slug: rawCategory.slug || slugify(categoryName),
      description: rawCategory.description || `${categoryName}ç±»å‹çš„æ¼«ç”»ä½œå“`,
      icon: rawCategory.icon || 'ğŸ¨',
      color: rawCategory.color || '#8b5cf6',
      isNew: rawCategory.isNew || false,
    }

    const tagsArray = Array.isArray(parsed.tags) ? parsed.tags.slice(0, 5) : []
    const tags = tagsArray.map((t: any) => {
      const name = t?.name || 'AIç”Ÿæˆ'
      return {
        name,
        slug: t?.slug || slugify(name),
        color: t?.color || '#8b5cf6',
      }
    })

    console.log('æ¼«ç”»å†…å®¹ç”ŸæˆæˆåŠŸ:', { title, volumeCount: volumes.length })
    return {
      success: true,
      data: {
        title,
        description,
        style,
        category,
        tags,
        volumes
      },
    }
  } catch (error: any) {
    console.error('æ¼«ç”»å†…å®¹ç”Ÿæˆå¤±è´¥:', error)
    return {
      success: false,
      error: 'æ¼«ç”»å†…å®¹ç”Ÿæˆå¤±è´¥',
      detail: error?.message || 'unknown error',
      data: {
        title: prompt,
        description: `ä¸€ä¸ªå…³äº${prompt}çš„ç²¾å½©æ¼«ç”»æ•…äº‹`,
        style: 'anime',
        category: {
          name: 'AIç”Ÿæˆ',
          slug: 'ai-generated',
          description: 'ç”±AIæ™ºèƒ½ç”Ÿæˆçš„æ¼«ç”»ä½œå“',
          icon: 'ğŸ¨',
          color: '#8b5cf6',
          isNew: false,
        },
        tags: [],
        volumes: [
          {
            title: 'ç¬¬1å·',
            description: 'æ•…äº‹å¼€å§‹...',
            episodes: [
              {
                title: 'ç¬¬1è¯',
                description: 'æ•…äº‹å¼€å§‹...',
                panels: []
              }
            ]
          }
        ]
      },
    }
  }
}